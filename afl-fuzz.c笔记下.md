## **下篇序：**
上一篇已经将前三部分写完了，但是留有一些疑问点，所以下篇将分三部分：对上篇遗留问题的解决、关键函数实现原理介绍（其中会重点说一篇论文CollAFL）、main函数注释（逐行贴出代码块，因为main是整个alf的核心流程，所以需要详解，当然上篇讲到的在第五部分就会一笔掠过啦）  
最后会有附录，写有我看过实用的相关链接。

--------------------------------------------------------------
## **接上篇遗留的问题**
先来说说上一篇未解决的问题（可以在上篇中用搜索🔍【？？】快速定位，这几个问题主要是在代码细节的理解上，有错误之处还望斧正）：
#### 1. 数组`eff_map`  
>关于`effector map`，在看源码数据变异这一部分的时候，一定会注意的是在 bitflip 8/8 的时候遇到一个叫`eff_map`的数组，这个数组的大小是`EFF_ALEN(len)`，这个数是多大？  

当时没找到，后来转过弯来，其实那不是单纯的变量，`EFF_ALEN`是宏定义的函数：
``` C++
#define EFF_APOS(_p)          ((_p) >> EFF_MAP_SCALE2)
#define EFF_REM(_x)           ((_x) & ((1 << EFF_MAP_SCALE2) - 1))
#define EFF_ALEN(_l)          (EFF_APOS(_l) + !!EFF_REM(_l))
#define EFF_SPAN_ALEN(_p, _l) (EFF_APOS((_p) + (_l) - 1) - EFF_APOS(_p) + 1)

  /* Initialize effector map for the next step (see comments below). Always
     flag first and last byte as doing something. */

  eff_map    = ck_alloc(EFF_ALEN(len));
```
如果把这一块的宏定义拆开，变成函数的形式就是这样：
``` C++
//此部分为伪代码，其实宏定义虽然写代码的时候好用，有点像内联（个人感觉）但是不得不说写法有点难理解，所以我又给拆分成了通俗的代码，这部分跟上下文关系不大，看懂这部分，其他类似的也很好懂了。
type(_p) EFF_APOS(_p){
    //

}
type

```
#### 2. bitflip
>如果加减某数之后效果与之前某bitflip效果相同，认为此次变异在上一阶段已经执行过，此次不再执行  

这里当时没有理解透彻的是，作者是怎么实现的，后来经过仔细分析几个变量的关系，才缕清楚，这里把8/8变异这一段重新贴一下(16/32变异大同小异)，并把重要部分做解释：
``` C++

```
#### 3. 为什么不是当前的尾拼接随机文件的头

#### 4. 
--------------------------------------------------------------
## **Ⅳ、关键函数实现原理**
这部分详细解释一个变量 `eff_map` 和三个函数、、
### 1. eff_map
看代码的话，在变异阶段，这是个贯穿始终的数组，刚开始第一遍看代码其实不是理解的很深刻，现在理解的比较多了，这个变量的设计思想大概如下：  
#### 【1】主要功能，用于标记
#### 【2】实现思路
### 2. 
### 3. 
### 4. 

--------------------------------------------------------------
## **Ⅴ、main函数**
main函数逐块分析，这部分可能会有点长，大家随意看看就好，算是自己看代码的碎碎念吧，因为不少在前面已经解释过了，这里算是总结了，**这篇对源代码对解读比我更好，形式也比我的好看**，我这算是献丑了233333）  

``` C++

```

--------------------------------------------------------------
## **Ⅵ、附录**
### AFL教程

### Fuzz相关

### 杂七杂八看过的有价值的文章

### 写在最后
下篇本来很快能完成的，但是中间被导师安排了一些杂七杂八的事情，就一直拖到现在，还好现在已经进入正轨了，期间有同学发私信一起讨论，如果大家也想一起讨论，或者对文章内容有异议欢迎留言，或者发邮件 wayne-tao(at)Outlook.com，我也是上学期末对时候下定决心搞这方面的，再加上本科不是搞安全的，所以进步很慢。  
文章和注释源码 git地址：，除了上下两篇对 afl.c 文件对分析，还有两篇对cmin和tmin的分析，这两个因为没多少技术含量就不放看雪了，感兴趣可以看一下我对博客（对两个工具对分析和小修改），
目前一方面搞fuzz，一方面也在搞web安全（毕竟新入门的水平比较菜，这个好入门），后面也会学一学二进制，因为经常是发现一些崩溃情况，但是不知道怎么入手分析就很烦，感觉入门还早，继续努力把吧。  
最后，谢谢大家看我的文章，希望大家都有所收获，早发文章。